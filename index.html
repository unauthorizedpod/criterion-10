import React, { useState, useEffect, useCallback, useMemo } from 'react';
import { Search, Film, X, Star, AlertCircle, Send, CheckCircle, Loader } from 'lucide-react';

// Modal Component (no changes needed)
const Modal = ({ message, isOpen, onClose }) => {
    if (!isOpen) return null;
    return (
        <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
            <div className="bg-gray-800 rounded-lg shadow-xl max-w-sm w-full p-6 text-center border border-indigo-500">
                <div className="flex justify-center mb-4"><AlertCircle className="text-indigo-400" size={48} /></div>
                <h3 className="text-lg font-semibold text-white mb-4">{message}</h3>
                <button onClick={onClose} className="bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-indigo-500 transition-colors duration-300">Close</button>
            </div>
        </div>
    );
};

// Main App Component
const App = () => {
    // State variables
    const [searchTerm, setSearchTerm] = useState('');
    const [searchResults, setSearchResults] = useState([]);
    const [selectedMovies, setSelectedMovies] = useState([]);
    const [isLoading, setIsLoading] = useState(false);
    const [error, setError] = useState(null);
    const [isSearchFocused, setIsSearchFocused] = useState(false);
    const [modalMessage, setModalMessage] = useState('');
    const [isModalOpen, setIsModalOpen] = useState(false);
    
    // State for submission status
    const [submissionStatus, setSubmissionStatus] = useState('idle'); // 'idle', 'submitting', 'success', 'error'
    
    // --- NEW: State to track if the user has already voted ---
    const [hasVoted, setHasVoted] = useState(false);

    // --- TMDb API Configuration ---
    const TMDB_API_KEY = "746e663319009236f390938e29383ae0"; 
    const API_BASE_URL = 'https://api.themoviedb.org/3';
    
    // Google Sheets URL is hardcoded
    const GOOGLE_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyJPk6fkl4fjkmR5ZnSqNx-blBOz5gPHopzagxK8BseHLCNC0O-vS2DivOsDbdKogwa/exec";

    // API Search URL
    const searchUrl = useMemo(() => 
        `${API_BASE_URL}/search/movie?api_key=${TMDB_API_KEY}&query=${encodeURIComponent(searchTerm)}&primary_release_date.gte=2000-01-01`,
        [searchTerm, TMDB_API_KEY]
    );

    // --- NEW: Check localStorage on initial load ---
    useEffect(() => {
        const votedStatus = localStorage.getItem('hasVotedTop10Movies');
        if (votedStatus === 'true') {
            setHasVoted(true);
        }
    }, []);

    // Live API Fetching with Debouncing
    useEffect(() => {
        if (searchTerm.trim().length < 2 || !TMDB_API_KEY) {
            setSearchResults([]);
            return;
        }
        setIsLoading(true);
        setError(null);
        const debounceTimer = setTimeout(async () => {
            try {
                const response = await fetch(searchUrl);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.status_message || 'Network response was not ok.');
                }
                const data = await response.json();
                const filteredResults = data.results.filter(movie => 
                    movie.poster_path && 
                    movie.release_date && 
                    new Date(movie.release_date) >= new Date('2000-01-01')
                );
                setSearchResults(filteredResults);
            } catch (err) {
                setError(err.message);
            } finally {
                setIsLoading(false);
            }
        }, 300);
        return () => clearTimeout(debounceTimer);
    }, [searchTerm, searchUrl, TMDB_API_KEY]);

    // --- Event Handlers ---

    const handleSelectMovie = useCallback((movie) => {
        if (selectedMovies.length >= 10) {
            setModalMessage("You can only select up to 10 movies.");
            setIsModalOpen(true);
            return;
        }
        if (!selectedMovies.some(m => m.id === movie.id)) {
            setSelectedMovies(prev => [...prev, movie]);
        }
        setSearchTerm('');
        setSearchResults([]);
        setIsSearchFocused(false);
    }, [selectedMovies]);

    const handleRemoveMovie = useCallback((movieId) => {
        setSelectedMovies(prev => prev.filter(m => m.id !== movieId));
    }, []);
    
    // Handles submission to the hardcoded Google Apps Script URL
    const handleSubmitList = async () => {
        setSubmissionStatus('submitting');
        
        const movieTitles = selectedMovies.map(m => m.title);
        const payload = {
            movies: movieTitles
        };

        try {
            await fetch(GOOGLE_WEB_APP_URL, {
                method: 'POST',
                mode: 'no-cors',
                cache: 'no-cache',
                redirect: 'follow',
                body: JSON.stringify(payload),
                headers: { 'Content-Type': 'text/plain;charset=utf-8' }
            });

            setSubmissionStatus('success');
            
            // --- NEW: Set flag in localStorage after successful submission ---
            localStorage.setItem('hasVotedTop10Movies', 'true');
            setHasVoted(true);

            setTimeout(() => { 
                setSelectedMovies([]); 
                setSubmissionStatus('idle');
            }, 2000);

        } catch (error) {
            console.error('Submission Error:', error);
            setSubmissionStatus('error');
            setModalMessage('Failed to submit list. Please check your script setup.');
            setIsModalOpen(true);
             setTimeout(() => setSubmissionStatus('idle'), 3000);
        }
    };
    
    // --- Render Helper Components ---
    const MovieSearchResultItem = ({ movie }) => (
        <li key={movie.id} onClick={() => handleSelectMovie(movie)} className="flex items-center p-3 cursor-pointer hover:bg-gray-700 transition-colors duration-150 rounded-lg">
            <img src={`https://image.tmdb.org/t/p/w92${movie.poster_path}`} alt={`${movie.title} poster`} className="w-12 h-auto rounded-md mr-4 bg-gray-600" onError={(e) => { e.target.onerror = null; e.target.src='https://placehold.co/92x138/1f2937/4b5563?text=N/A'; }} />
            <div className="flex-1"><p className="font-semibold text-white">{movie.title}</p><p className="text-sm text-gray-400">{movie.release_date ? new Date(movie.release_date).getFullYear() : 'N/A'}</p></div>
        </li>
    );

    const SelectedMovieCard = ({ movie, onRemove }) => (
         <div className="relative bg-gray-800 rounded-lg overflow-hidden shadow-lg transform hover:scale-105 transition-transform duration-300 group">
            <img src={`https://image.tmdb.org/t/p/w300${movie.poster_path}`} alt={`${movie.title} poster`} className="w-full h-auto" onError={(e) => { e.target.onerror = null; e.target.src='https://placehold.co/300x450/1f2937/4b5563?text=Poster'; }} />
            <div className="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent flex flex-col justify-end">
                <div className="p-3 w-full"><h3 className="text-white font-bold text-sm truncate">{movie.title}</h3><div className="flex items-center text-xs text-yellow-400 mt-1"><Star size={14} className="mr-1 fill-current" /><span>{movie.vote_average.toFixed(1)}</span></div></div>
            </div>
            <button onClick={() => onRemove(movie.id)} className="absolute top-2 right-2 bg-black/50 text-white rounded-full p-1 opacity-0 group-hover:opacity-100 transition-opacity duration-200 hover:bg-red-500" aria-label={`Remove ${movie.title}`}><X size={16} /></button>
        </div>
    );
    
    // --- Main Render ---
    return (
        <>
            <Modal message={modalMessage} isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} />
            <div className="bg-gray-900 text-gray-200 min-h-screen font-sans p-4 sm:p-6 lg:p-8">
                <div className="max-w-4xl mx-auto">
                    <header className="text-center mb-8">
                        <h1 className="text-4xl sm:text-5xl font-bold text-white mb-2">Your Top 10 Movies</h1>
                        <p className="text-lg text-gray-400">Search and select your all-time favorites (from 2000-present).</p>
                    </header>
                    
                    {/* --- UPDATE: Conditionally render search/picks or thank you message --- */}
                    {hasVoted ? (
                        <div className="text-center py-20 bg-gray-800 rounded-lg">
                            <CheckCircle className="mx-auto text-green-400" size={64} />
                            <h2 className="mt-4 text-3xl font-bold text-white">Thank You For Your Submission!</h2>
                            <p className="mt-2 text-gray-400">Your list has been recorded.</p>
                        </div>
                    ) : (
                        <>
                            <div className="relative mb-6"><div className="relative"><Search className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400" size={20} /><input type="text" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} onFocus={() => setIsSearchFocused(true)} onBlur={() => setTimeout(() => setIsSearchFocused(false), 150)} placeholder="Search for a movie..." className="w-full bg-gray-800 border-2 border-gray-700 rounded-lg py-3 pl-12 pr-4 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all" /></div>{isSearchFocused && (searchTerm.length > 1) && (<div className="absolute z-10 w-full mt-2 bg-gray-800 border border-gray-700 rounded-lg shadow-2xl overflow-hidden">{isLoading && <p className="p-4 text-center text-gray-400">Searching...</p>}{error && <p className="p-4 text-center text-red-400">Error: {error}</p>}{!isLoading && !error && searchResults.length > 0 && (<ul className="max-h-96 overflow-y-auto">{searchResults.map(movie => <MovieSearchResultItem key={movie.id} movie={movie} />)}</ul>)}{!isLoading && !error && searchResults.length === 0 && searchTerm.length > 1 && (<p className="p-4 text-center text-gray-400">No movies found from 2000 or later.</p>)}</div>)}</div>
                            <main><div className="flex justify-between items-center mb-4"><h2 className="text-2xl font-semibold">Your Picks ({selectedMovies.length}/10)</h2><button onClick={() => setSelectedMovies([])} className={`text-sm text-gray-400 hover:text-white transition-colors ${selectedMovies.length === 0 ? 'opacity-50 cursor-not-allowed' : ''}`} disabled={selectedMovies.length === 0}>Clear All</button></div>{selectedMovies.length > 0 ? (<div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">{selectedMovies.map(movie => (<SelectedMovieCard key={movie.id} movie={movie} onRemove={handleRemoveMovie} />))}</div>) : (<div className="flex flex-col items-center justify-center text-center py-16 px-6 border-2 border-dashed border-gray-700 rounded-lg"><Film size={48} className="text-gray-600 mb-4" /><h3 className="text-xl font-semibold text-white">Your list is empty</h3><p className="text-gray-500 mt-1">Use the search bar above to find and add movies.</p></div>)}</main>
                            
                            <footer className="mt-8 text-center border-t-2 border-gray-800 pt-8">
                                <button
                                    onClick={handleSubmitList}
                                    disabled={selectedMovies.length !== 10 || submissionStatus === 'submitting'}
                                    className="bg-indigo-600 w-60 text-white font-bold py-3 px-8 rounded-lg shadow-lg hover:bg-indigo-500 disabled:bg-gray-600 disabled:cursor-not-allowed disabled:opacity-70 transition-all duration-300 transform hover:scale-105 flex items-center justify-center mx-auto"
                                >
                                    {submissionStatus === 'submitting' && <Loader className="animate-spin mr-2" size={20} />}
                                    {submissionStatus === 'success' && <CheckCircle className="mr-2" size={20} />}
                                    {submissionStatus === 'success' ? 'Submitted!' : `Submit Top 10`}
                                </button>
                                {selectedMovies.length !== 10 && <p className="text-gray-500 text-sm mt-3">Please select {10 - selectedMovies.length} more movie(s).</p>}
                            </footer>
                        </>
                    )}
                </div>
            </div>
        </>
    );
};

export default App;
